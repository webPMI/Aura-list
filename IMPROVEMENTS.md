# AuraList - Improvement Roadmap

> Generated by /init orchestration analysis — 5 specialized agents, 2026-02-17

---

## Quick Wins

Small changes with high user impact. Each can be implemented in a single focused session.

### ~~UX-1: Undo on Task Deletion~~ ✅ COMPLETADO (2026-02-15)
**Files changed:** `lib/widgets/task_tile.dart`, `lib/providers/task_provider.dart`
**Implemented:** After confirming deletion, a floating SnackBar appears for 5 seconds with a "Deshacer" button. Tapping it calls `restoreTask()` which re-saves locally and re-syncs to cloud.

### ~~WB-1: Grace Days for Streaks~~ ✅ COMPLETADO (2026-02-15)
**Files changed:** `lib/providers/streak_provider.dart`, `lib/screens/dashboard_screen.dart`
**Implemented:** 2 grace days/month. When user misses exactly 1 day and has grace days remaining, a dialog appears on the Dashboard offering to preserve the streak. Monthly auto-reset of grace day count.

### ~~A11Y-1: Semantic Labels on Icon Buttons~~ ✅ COMPLETADO (2026-02-15)
**Files changed:** `lib/screens/home_screen.dart`, `lib/widgets/navigation/adaptive_navigation.dart`, `lib/screens/notes_screen.dart`
**Implemented:** Moved sync button tooltip from outer `Tooltip` wrapper to `IconButton.tooltip` for proper semantic button labeling. Added `tooltip: 'Más opciones'` to `PopupMenuButton`. Wrapped decorative `Icon(Icons.check_circle_outline)` in NavigationRail with `ExcludeSemantics`. Added `tooltip: 'Limpiar búsqueda'` to notes search clear button. All other icon buttons were already correctly labelled.

### ~~CODE-1: Log Silent Failures in Achievement System~~ ✅ COMPLETADO (2026-02-15)
**File changed:** `lib/widgets/task_tile.dart`
**Implemented:** Added `import '../services/logger_service.dart'` and replaced all 4 silent failure points with `LoggerService().error(tag, msg, error: e, stack: stack)` calls: `_checkAndShowStreakCelebration`, `_checkAndShowAchievements`, `_incrementGuideAffinity`, and the undo-restore catch block. UX remains uninterrupted; errors now surface in logs with full stack traces for diagnosis.

### ~~UX-4: Undo for Task Completion Toggle~~ ✅ COMPLETADO (2026-02-17)
**File changed:** `lib/widgets/task_tile.dart`
**Implemented:** Extracted `_performToggle()` method consolidating both swipe-right and checkbox handlers. After any toggle, a floating SnackBar appears for 5 seconds with "Deshacer". The undo action calls `updateTask(task.copyWith(isCompleted: wasCompleted))` to restore the exact pre-toggle state (safer than a second `toggleTask` call). Daily task history record is also reversed on undo. Celebrations still fire only on completion, not on undo. Duplicate toggle logic removed from two call sites.

### UX-5: Swipe Gesture Affordance (First-Use Hint)
**Files:** `lib/widgets/task_tile.dart`
**What:** Show a one-time tooltip/hint on the first task tile ("← Eliminar / Completar →") for new users. Store shown state in SharedPreferences. Add subtle drag-handle visual indicator on task edges.
**Why:** Swipe right (complete) and swipe left (delete) are implemented but not discoverable. Agent found zero visual affordance cue at `task_tile.dart:356-415`.
**Use /implement UX-5**

### A11Y-5: Semantic Labels for Celebration Overlay
**Files:** `lib/widgets/shared/celebration_overlay.dart`
**What:** Wrap the `Positioned.fill` overlay in `Semantics(label: 'Tarea completada exitosamente', liveRegion: true)`. Add `SemanticsService.announce()` for screen readers.
**Why:** The CelebrationOverlay uses `IgnorePointer` with no semantic info (`celebration_overlay.dart:94`). Screen reader users get no feedback when a task is completed.
**Use /implement A11Y-5**

### ~~CODE-3: Fix StreakProvider Initialization Race Condition~~ ✅ COMPLETADO (2026-02-17)
**Files changed:** `lib/providers/streak_provider.dart`, `lib/screens/dashboard_screen.dart`
**Implemented:** Added `final Completer<void> _initCompleter` field to `StreakNotifier`. Wrapped `_loadStreak()` body in `try/finally` so the completer always signals completion even if loading throws. Exposed `ensureInitialized()` method returning `_initCompleter.future`. Replaced the fragile `await Future.delayed(const Duration(milliseconds: 500))` in `DashboardScreen._checkGraceDayOffer()` with `await ref.read(streakProvider.notifier).ensureInitialized()` — now deterministic, not timing-dependent.

### CODE-4: Extend `_deleteAndSync` Mixin to Notes Notifiers
**Files:** `lib/providers/notes_provider.dart`
**What:** The `_NoteSyncMixin` covers save/sync but not deletes. Three notifiers repeat identical try/catch delete logic (lines 183-204, 236-257, 329-350). Add `_deleteAndSync()` to the mixin and replace all three implementations.
**Why:** Code-2 already extracted saves. Deletes still have 3 copies of the same error handler. One bug fix requires 3 edits.
**Use /implement CODE-4**

---

## Medium Effort

Features requiring a few hours to a day. High value for daily users.

### ~~UX-2: Smart Task Filter Bar~~ ✅ COMPLETADO (2026-02-15)
**File changed:** `lib/widgets/task_list.dart`
**Implemented:** Horizontal scrollable row of 4 FilterChips (Todas / Alta / Pendientes / Urgentes) with live count badges. Chips stack with AND logic. Filters are local state (no provider needed). Distinct empty state when no tasks match the active filter. Hidden during search mode.

### ~~UX-3: Quick Edit via Long-Press~~ ✅ COMPLETADO (2026-02-15)
**File changed:** `lib/widgets/task_tile.dart`
**Implemented:** Added `_showQuickEditSheet(context, ref)` method and wired it to `ListTile.onLongPress`. A modal bottom sheet slides up with: 3 priority `ChoiceChip`s (Baja/Media/Alta, current one highlighted in its priority colour), 5 category chips (current highlighted in primary colour), and a full-width "Marcar como completada/pendiente" `FilledButton`. Each action pops the sheet and calls `updateTask`/`toggleTask` with `onFeedback` confirmation. `HapticFeedback.selectionClick()` on trigger.

### ~~PROD-1: Focus Mode / Today View~~ ✅ COMPLETADO (2026-02-15)
**Files changed:** `lib/screens/today_screen.dart` (new), `lib/widgets/navigation/app_drawer.dart`, `lib/screens/dashboard_screen.dart`
**Implemented:** New `TodayScreen` watches `todaySmartTasksProvider` to aggregate all tasks due today across every type. Tasks sorted: incomplete first (overdue → urgent → priority desc), completed last. Real-time `_TodayProgressHeader` shows X/Y counter + `LinearProgressIndicator`. Accessible via a "Modo Enfoque" tile in the drawer and a `_FocusModeCard` on the dashboard (shows pending count). Uses `Navigator.push` to avoid AppRoute index conflicts.

### ~~CODE-2: Extract Notes Save+Sync Pattern~~ ✅ COMPLETADO (2026-02-15)
**File changed:** `lib/providers/notes_provider.dart`
**Implemented:** Added `_NoteSyncMixin` with a single `_saveAndSync(note, {errorMessage, userMessage})` method. All three notifiers (`IndependentNotesNotifier`, `ArchivedNotesNotifier`, `TaskNotesNotifier`) now use `with _NoteSyncMixin` and 8 repeated try/catch save+sync blocks were replaced with calls to `_saveAndSync`. The mixin declares abstract getters for `_db`, `_auth`, `_errorHandler` satisfied by each class's existing fields.

### ~~UX-6: Progressive Disclosure in Task Creation Form~~ ✅ COMPLETADO (2026-02-17)
**File changed:** `lib/widgets/dialogs/add_task_dialog.dart`
**Implemented:** Required fields (type chips, recurrence day when applicable, title, priority, category) are always visible. Five optional fields (due date, due time, motivation, reward, deadline) are collapsed under an `ExpansionTile` labeled "Más opciones". A pill badge on the collapsed header shows how many advanced fields are currently filled (updates reactively via `setState`). The `ExpansionTile` is wrapped in a `Theme(data: ..copyWith(dividerColor: Colors.transparent))` to suppress its built-in horizontal dividers. Due time picker only appears when a due date is set.

### UX-7: Skeleton Loading States
**Files:** `lib/screens/today_screen.dart`, `lib/widgets/task_list.dart`
**What:** Replace `CircularProgressIndicator` with shimmer-style skeleton tiles that mirror the final task list layout. Show contextual label ("Cargando tareas de hoy...") on loading.
**Why:** Agent found blank `CircularProgressIndicator` with no context at `today_screen.dart:45-49`. Sudden content appearance feels jarring on slower devices; skeleton loading improves perceived performance.
**Use /implement UX-7**

### WB-2: Mindful Completion Pause
**Files:** `lib/widgets/task_tile.dart`, new `lib/widgets/shared/mindful_completion_screen.dart`
**What:** On task completion: 1-2 second pause showing task's motivation/reward before confetti animation. Creates moment of genuine satisfaction, prevents task-checking addiction loop.
**Why:** Slows dopamine rush to reinforce "why" behind the task. Connects daily wins to long-term values.
**Use /implement WB-2**

### WB-5: Celebration Intensity Settings
**Files:** `lib/widgets/shared/celebration_overlay.dart`, `lib/screens/dashboard_screen.dart`, `lib/screens/settings_screen.dart`
**What:** Add a "Celebration Preferences" setting with 3 levels: "Enthusiastic" (current full overlays), "Mindful" (reduced — sound only after 3rd task), "Silent" (badge only). Throttle full celebrations to max 1 per 15 minutes per type. Agent found `dashboard_screen.dart:566` fires overlay on EVERY completion with no throttle.
**Why:** After 10+ completions in a session, celebrations become noise (celebration fatigue). Preserves joy by being selective, not omnipresent. Also respects neurodiversity — ADHD/anxiety users may find constant overlays disruptive.
**Use /implement WB-5**

### WB-6: Adaptive Progress Visualization
**Files:** `lib/providers/stats_provider.dart`, `lib/screens/wellness_catalog_screen.dart`, `lib/screens/dashboard_screen.dart`
**What:** Replace raw % with contextual progress messages. Instead of "10% explorado" show "Descubriste 1 de 6 categorías". Track user's 4-week average completion rate and use it as personal baseline (shown as 100%), so a 55% week reads as "87% de tu promedio" not a failing grade.
**Why:** Raw numbers demoralize when percentages feel tiny. Agent found `stats_provider.dart:62-97` exposes percentages without personal context. Users need relative progress, not absolute metrics.
**Use /implement WB-6**

### A11Y-2: Minimum Touch Target Sizes
**Files:** `lib/widgets/dialogs/add_task_dialog.dart`, `lib/widgets/task_tile.dart`, `lib/widgets/task_list.dart`
**What:** Wrap small icon buttons (18px close icons in date pickers) in 48x48 `SizedBox`. Increase checkbox scale from 1.2x to 1.5x. Add `materialTapTargetSize: MaterialTapTargetSize.padded` to filter chips.
**Why:** Material Design minimum is 48x48dp. Current close icons (18px) and filter chip avatars fail accessibility standards (WCAG 2.5.5).
**Use /implement A11Y-2**

### A11Y-3: Reduce Motion Support
**Files:** `lib/main.dart`, `lib/widgets/task_tile.dart`, `lib/widgets/shared/celebration_overlay.dart`
**What:** Check `MediaQuery.of(context).disableAnimations` before running celebration animations and haptic feedback.
**Why:** Users with vestibular disorders or epilepsy need motion reduction support.
**Use /implement A11Y-3**

### CODE-5: Consolidate Duplicate Provider Architecture
**Files:** `lib/providers/task_provider.dart`, `lib/providers/task_providers.dart`
**What:** The app has two competing task-fetch systems: `tasksProvider` (StateNotifier with deduplication) and `tasksByTypeProvider` (StreamProvider, bypasses deduplication). Deprecate `tasksByTypeProvider` and route all consumers through `TaskNotifier`. Move deduplication to `HiveTaskStorage` as single source of truth.
**Why:** Agent found parallel deduplication logic causing potential inconsistency. Dashboard manually aggregates all 5 types (`dashboard_screen.dart:591-595`). Two data paths = double maintenance burden + data sync bugs.
**Use /implement CODE-5**

### CODE-6: Composite `dailyStatsProvider` for Performance
**Files:** `lib/widgets/task_tile.dart`, `lib/screens/dashboard_screen.dart`
**What:** Create a `dailyStatsProvider` that computes completed count, allCompleted bool, and category set in a single pass. Use `.select()` in dashboard widgets to watch only needed fields. Replace the 5 separate `ref.watch(tasksProvider(...))` calls in `_UpcomingDeadlinesCard`.
**Why:** Agent found `task_tile.dart:94-149` reads task provider 5 separate times for achievement checks. Dashboard `_UpcomingDeadlinesCard` watches all 5 task types — a single task completion triggers full card rebuild. Using `.select()` reduces rebuilds by ~60%.
**Use /implement CODE-6**

---

## Major Features

Multi-day implementations. Strategic improvements to the product.

### PROD-2: Push Notifications & Deadline Escalation
**What:** Local notifications for deadlines: 1 week before (gentle), 1 day before (prominent), 2 hours before (urgent). Add `flutter_local_notifications` package. Visual urgency escalation (overdue tasks surface to top with red indicator).
**Why:** The `deadline` field exists but has no enforcement. Users miss deadlines because they don't see reminders.
**Use /implement PROD-2**

### PROD-3: Batch Operations
**What:** Multi-select mode in TaskList. Long-press to enter selection mode. Batch: change priority, reassign category, extend deadlines, mark complete, delete. Smart presets: "Select all overdue + high priority."
**Why:** Moving or updating groups of tasks (e.g., reorganizing a project) currently requires N individual edits.
**Use /implement PROD-3**

### PROD-4: Task Templates
**What:** Save completed tasks as templates. Template library with presets (Sprint Planning, Home Maintenance, Health Check-in). Apply template to instantly create a task with pre-filled priority/category/motivation/reward.
**Why:** Power users recreate the same task structures weekly. Templates eliminate decision fatigue for recurring workflows.
**Use /implement PROD-4**

### PROD-5: Voice & Natural Language Task Input
**What:** Integrate `speech_to_text` package. Add a microphone button to `AddTaskDialog`. Parse natural language phrases ("llama a mamá mañana a las 3pm") to auto-fill title, due date, and due time. Fallback to manual entry if parsing fails.
**Why:** No voice capture exists. Mobile users on-the-go have 3x faster capture with voice. The task creation form (`add_task_dialog.dart`) has all fields but no voice entry point.
**Use /implement PROD-5**

### PROD-6: Task Subtasks / Nested Checklists
**What:** Add `subtasks: List<Subtask>` to the `Task` model. Show subtask progress on the tile ("3/5 subtareas"). Allow blocking task completion until all subtasks are done (optional). TaskTile expansion reveals subtask list inline.
**Why:** The `Note` model has `ChecklistItem` but these are detached from tasks. Users with multi-step workflows (sprint retros, home projects) have no way to structure tasks into steps.
**Use /implement PROD-6**

### PROD-7: Quick Capture Home Screen Widget
**What:** Add Android/iOS home screen widget using `home_widget` package. Widget shows top 3 today's urgent tasks + a one-tap add button that opens a quick-capture overlay. Background Dart execution saves directly to Hive.
**Why:** Users must fully open the app → tap FAB → fill form to create a task (~30s). A widget reduces capture to <5s and increases daily engagement rate.
**Use /implement PROD-7**

### WB-3: Daily Capacity Indicator
**Files:** New `lib/widgets/dashboard/capacity_indicator_card.dart`, `lib/screens/dashboard_screen.dart`
**What:** Based on 14-day completion history, calculate sustainable daily task count. Show indicator: "Buen ritmo (2-3 tareas)" or "¡Atención! (7+ tareas, riesgo de agotamiento)".
**Why:** Prevents anxiety-inducing overload. Users feel accomplished with realistic goals rather than stressed by impossible lists.
**Use /implement WB-3**

### WB-4: Weekly Reflection Screen
**Files:** New `lib/screens/weekly_reflection_screen.dart`, trigger in `lib/providers/day_cycle_provider.dart`
**What:** Sunday prompt showing week's completion rate, streaks, wellness activities tried. Reflection prompts (optional notes). If >80% completion for 4+ weeks: gentle nudge to ease up and rest.
**Why:** Breaks the "always running" mentality. Guided reflection creates self-compassion, not just metrics.
**Use /implement WB-4**

### WB-7: Workload Radar + Overwhelm Detection
**Files:** `lib/screens/dashboard_screen.dart`, `lib/widgets/dashboard/wellness_suggestions_card.dart`
**What:** Calculate total daily recommended items (all task types + wellness suggestions). Show a color-coded indicator: Green (3-8, healthy), Yellow (8-15, consolidate), Red (15+, defer non-urgent). When over 15: auto-hide wellness suggestions, prompt "¿Quieres diferir las tareas de Bienestar?" Smart deferral moves oldest uncompleted low-priority tasks to tomorrow.
**Why:** Agent found `wellness_suggestions_card.dart:66-118` generates 6 suggestions with no capacity check. A user with 8 daily + 5 weekly + 6 wellness = 19 "suggested" items. No system warns or helps manage this. Extends WB-3's indicator with active intervention.
**Use /implement WB-7**

### WB-8: Evening Reflection Card
**Files:** `lib/providers/day_cycle_provider.dart`, new `lib/widgets/dashboard/evening_reflection_card.dart`
**What:** Show a card at 19:00-20:00 (dismissable): summary of today's completions, top 3 wins (with motivation text), tomorrow's highest-priority tasks, guide reaction. Optional single-line gratitude capture ("Lo que lograste hoy...").
**Why:** `guide_farewell_widget.dart:220-225` shows only a 5-second generic goodnight — no reflection of actual progress. Users complete tasks but never review wins before tomorrow. Evening ritual creates closure, reduces rumination, and builds positive memory of effort.
**Use /implement WB-8**

### A11Y-4: Dynamic Text Scaling Support
**Files:** `lib/main.dart`, all widget files
**What:** Replace hardcoded `fontSize:` with `Theme.of(context).textTheme` styles. Add `builder:` in MaterialApp to respect system text size settings. Fix `app_drawer.dart:338-344` header title which uses hardcoded `fontSize: 22` causing overflow at large text scales.
**Why:** 15-20% of users increase text size in accessibility settings. Fixed sizes cause overflow/truncation. Agent confirmed drawer header and several widget sizes are hardcoded (WCAG 1.4.4).
**Use /implement A11Y-4**

---

---

## AUTH & SYNC — Análisis 2026-02-17 (Agentes especializados)

> Análisis profundo de autenticación, perfiles de usuario, sincronización y flujos de cuenta.

### AUTH-1: Crear Documento de Perfil en Firestore al Registrarse ⚠️ CRÍTICO
**Files:** `lib/services/auth_service.dart`, `lib/services/database_service.dart`, `lib/models/user_profile_model.dart`
**Problema:** El modelo `UserProfile` (typeId:8) existe con campos: uid, email, displayName, photoUrl, createdAt, lastLoginAt, hasAcceptedTerms, preferredGuideId. Sin embargo, NUNCA se guarda en Hive ni en Firestore después del registro. Si las reglas de seguridad de Firestore requieren que exista `users/{uid}` antes de poder escribir `users/{uid}/tasks`, los usuarios nuevos no pueden sincronizar.
**Solución:**
1. Agregar `saveUserProfile(UserProfile profile)` a `DatabaseService` que guarde en Hive y en `users/{uid}` de Firestore
2. Llamar `saveUserProfile()` después de registro con email, después de vincular Google, y después del primer auth anónimo
3. Verificar que las reglas de Firestore permitan escritura si no existe el documento de perfil (o crearlo automáticamente)
**Impacto:** Usuarios nuevos que se registran no pueden sincronizar sus datos — bloquea la función principal de la app.
**Use /implement AUTH-1**

### AUTH-2: Visibilidad de "Eliminar Cuenta" en Ajustes ⚠️ CRÍTICO
**Files:** `lib/screens/settings_screen.dart`, `lib/screens/profile_screen.dart`
**Problema:** La opción "Eliminar cuenta" EXISTE y está completamente implementada (profile_screen.dart:213-317, con confirmación en 2 pasos y texto "ELIMINAR"), pero está enterrada dentro de la pantalla de Perfil → sección de privacidad. Muchos usuarios no la encuentran. En Ajustes (`settings_screen.dart`) solo aparece "Eliminar todos los datos locales" (diferente).
**Solución:**
1. Agregar un acceso directo a "Eliminar cuenta" en `settings_screen.dart` en la sección de "Cuenta"
2. En la pantalla de Perfil, mover la acción a una sección "Zona de peligro" claramente etiquetada con un separador visual rojo
3. El `delete_account_dialog.dart` existente es excelente — solo necesita ser más accesible
**Impacto:** Usuarios que buscan la opción no la encuentran — frustración, posibles reseñas negativas.
**Use /implement AUTH-2**

### AUTH-3: Cambio de Contraseña desde la App
**Files:** `lib/screens/profile_screen.dart`, new `lib/widgets/dialogs/change_password_dialog.dart`
**Problema:** No existe UI para cambiar contraseña mientras estás autenticado. Solo hay un "Olvidé mi contraseña" en la pantalla de login que envía email. El método `updatePassword()` de Firebase Auth existe pero no está expuesto en ninguna pantalla.
**Solución:**
1. Crear `change_password_dialog.dart` con: campo contraseña actual (verificación), campo contraseña nueva (con `password_strength_indicator.dart` existente), campo confirmar nueva
2. Llamar `FirebaseAuth.currentUser!.reauthenticateWithCredential()` antes de `updatePassword()`
3. Agregar opción en `profile_screen.dart` → sección Cuenta, solo visible si el proveedor es email
**Impacto:** Usuarios con email/contraseña no pueden actualizar su contraseña de forma segura sin salir de la app.
**Use /implement AUTH-3**

### AUTH-4: Edición de Perfil (Nombre y Avatar)
**Files:** `lib/screens/profile_screen.dart`, `lib/services/database_service.dart`
**Problema:** El perfil es solo lectura. `UserProfile` tiene campos `displayName` y `photoUrl` pero no hay UI para editarlos. El `displayName` de Firebase Auth tampoco se actualiza. Los widgets `_LoggedInCard` en `user_card.dart` muestran `displayName` de Firebase pero no tienen forma de que el usuario lo cambie.
**Solución:**
1. Agregar botón "Editar perfil" en sección Cuenta de `profile_screen.dart`
2. Modal o pantalla inline con: campo nombre (3-30 chars), picker de avatar (emoji o color predeterminados)
3. Llamar `FirebaseAuth.currentUser!.updateDisplayName()` + guardar en Hive y Firestore vía `saveUserProfile()`
**Impacto:** Usuarios anónimos que vinculan Google ven su nombre de Google. Usuarios de email aparecen como "Usuario" sin nombre.
**Use /implement AUTH-4**

### AUTH-5: Verificación de Email Post-Registro
**Files:** `lib/screens/register_screen.dart`, `lib/services/auth_service.dart`
**Problema:** Usuarios pueden registrarse con cualquier email sin verificación. No se llama `sendEmailVerification()` post-registro. No hay indicador en la UI de si el email está verificado.
**Solución:**
1. Después del registro exitoso, llamar `FirebaseAuth.currentUser!.sendEmailVerification()`
2. Mostrar banner en `profile_screen.dart` si `user.emailVerified == false` con botón "Reenviar verificación"
3. Opcional: requerir verificación antes de habilitar sync a la nube
**Impacto:** Cualquiera puede crear cuentas con emails ajenos. Datos de otros usuarios podrían quedar en Firestore sin owner real.
**Use /implement AUTH-5**

### DATA-1: Exportar Datos (Implementación Real)
**Files:** `lib/screens/settings_screen.dart:86-91`, `lib/services/session_cache_manager.dart`
**Problema:** El botón "Exportar datos" en Ajustes tiene código placeholder que solo muestra un SnackBar de "próximamente". Sin embargo, `SessionCacheManager.exportBeforeClear()` y `DatabaseService.exportAllData()` ya están implementados y devuelven todos los datos.
**Solución:**
1. Conectar el botón existente a `exportBeforeClear()` del `session_cache_manager.dart`
2. Serializar a JSON y usar `share_plus` o `path_provider` para compartir/guardar el archivo
3. Mostrar diálogo con resumen de lo que se exportará (N tareas, N notas) antes de confirmar
**Impacto:** Feature prometida a usuarios que no funciona. Importante para cumplimiento GDPR.
**Use /implement DATA-1**

---

## SYNC & DATA INTEGRITY — Análisis Profundo 2026-02-17

> Análisis de integridad de datos, cola de sincronización y ciclo de vida de los datos de usuario.

### SYNC-1: Dead-Letter Queue sin Auto-Retry ⚠️ CRÍTICO
**Files:** `lib/services/sync/sync_queue.dart`, `lib/services/sync_orchestrator.dart`
**Problema:** La cola de sincronización tiene un sistema de dead-letter (después de 3 reintentos fallidos los items se mueven a dead-letter). Sin embargo, NO hay ningún mecanismo automático que reintente esos items. Los datos quedan atrapados en dead-letter indefinidamente. El método `retryDeadLetterItems()` existe pero no está expuesto en la UI ni llamado automáticamente. Usuarios con conexión inestable perderán datos en la nube sin saberlo.
**Solución:**
1. En `SyncOrchestrator`, agregar un timer periódico (cada 24h o al reconectarse) que llame `retryDeadLetterItems()`
2. Agregar badge/indicador en el icono de sync cuando hay items en dead-letter
3. Agregar botón "Reintentar sincronización fallida" en Ajustes → Datos
**Impacto:** Datos de usuario que fallan al sincronizar 3 veces quedan atrapados en dead-letter para siempre. El usuario cree que están en la nube pero no lo están.
**Use /implement SYNC-1**

### SYNC-2: `_markAllForResync()` Posiblemente Indefinido ⚠️ CRÍTICO
**Files:** `lib/services/session_cache_manager.dart:171`
**Problema:** La función `migrateAnonymousData()` llama a `_markAllForResync()` en la línea 171, pero esta función puede no estar definida o estar incompleta. Esto es el corazón de la migración de cuenta anónima → cuenta vinculada. Sin este paso, las tareas creadas como usuario anónimo no se re-sincronizan con el nuevo userId, quedando atrapadas en la cola con el userId anónimo antiguo que ya no coincide con las reglas de seguridad de Firestore.
**Solución:**
1. Verificar si `_markAllForResync()` está definido en `session_cache_manager.dart`
2. Si no: implementarlo — debe iterar por todos los items en la cola de sync y actualizar su `userId` al nuevo userId
3. Alternativamente: al vincular cuenta, hacer full resync (download + upload) con el nuevo userId
**Impacto:** Todos los datos creados como usuario anónimo fallan al sincronizarse después de vincular cuenta con Google o email.
**Use /implement SYNC-2**

### SYNC-3: Eliminación de Cuenta no es Atómica
**Files:** `lib/services/auth_service.dart:542-610`
**Problema:** La secuencia de borrado es: (1) borrar Firestore → (2) limpiar Hive local → (3) borrar Auth. Si el paso 1 falla (red, cuota, permisos), los pasos 2 y 3 aún se ejecutan. Resultado: el usuario pierde sus datos locales pero los datos en la nube permanecen. No hay rollback. Tampoco se limpian los items de la cola de sync pendientes del usuario borrado.
**Solución:**
1. Verificar éxito de paso 1 antes de continuar con paso 2. Si falla, mostrar error y abortar
2. Al inicio de la eliminación, guardar backup temporal de datos locales (ya existe `exportBeforeClear()`)
3. Restaurar backup si los pasos de la nube fallan
4. Limpiar queue de sync antes de borrar Hive
**Impacto:** Usuario que intenta borrar cuenta con mala conexión puede perder todos sus datos locales sin borrar los datos de la nube.
**Use /implement SYNC-3**

### SYNC-4: Filtro de UserId en TaskProvider
**Files:** `lib/providers/task_provider.dart`, `lib/services/storage/local/hive_task_storage.dart`
**Problema:** El `TaskProvider` observa el box de Hive global y devuelve TODAS las tareas sin filtrar por el userId actual. Si dos usuarios inician sesión en el mismo dispositivo sin limpiar datos, el segundo usuario verá las tareas del primero. El TaskProvider filtra por `type` pero no por `userId` del usuario autenticado actualmente.
**Solución:**
1. Al cargar tareas de Hive, filtrar por `task.userId == currentUserId` donde `currentUserId` viene del `authServiceProvider`
2. Al hacer logout, limpiar datos locales del usuario anterior (o al menos guardar en memoria qué userId corresponde a qué datos)
3. Agregar campo `userId` a la tarea si no existe, o usar el firestoreId para determinar ownership
**Impacto:** Privacidad y seguridad — datos de un usuario visibles para otro usuario en el mismo dispositivo.
**Use /implement SYNC-4**

---

## ANÁLISIS FRESCO — 2026-02-19 (5 agentes especializados)

> Segunda ronda de análisis. Los agentes exploraron el código actualizado e identificaron nuevas brechas no cubiertas por las iteraciones anteriores.

---

### UX-8: Sticky Submit Button en Formulario de Tarea
**Files:** `lib/widgets/dialogs/add_task_dialog.dart`
**What:** El formulario usa `SingleChildScrollView` pero el botón de guardar queda al final del scroll. Añadir un botón de guardar fijo en el footer que permanezca visible mientras el usuario llena el formulario.
**Why:** Agente encontró que `add_task_dialog.dart:232` usa scroll sin botón persistente. Usuarios no saben cómo guardar hasta hacer scroll completo. Aumenta tasa de abandono en creación de tareas.
**Use /implement UX-8**

### UX-9: Validación en Tiempo Real en Formulario
**Files:** `lib/widgets/dialogs/add_task_dialog.dart`
**What:** La validación del título solo ocurre al hacer submit (línea 167-174). Añadir: indicador "Requerido" en el campo título, validación inline mientras se escribe, contador de caracteres en motivación/recompensa, botón submit deshabilitado si título vacío.
**Why:** Los errores de validación solo aparecen después de submit fallido (`add_task_dialog.dart:238-241`). Elimina la frustración del ciclo "llenar → submit → error → corregir".
**Use /implement UX-9**

### UX-10: Agrupación Visual en Formulario de Edición
**Files:** `lib/widgets/dialogs/task_form_dialog.dart`
**What:** Agregar separadores de sección entre campos requeridos/opcionales. Usar patrón de selección consistente (todos chips o todos dropdowns). Añadir texto de ayuda bajo campos opcionales.
**Why:** `task_form_dialog.dart:212-430` mezcla prioridad como dropdown y categoría como chips. Sin separadores visuales entre secciones. Crea formulario confuso visualmente.
**Use /implement UX-10**

### UX-11: Feedback de Estado Deshabilitado durante Submit
**Files:** `lib/widgets/dialogs/add_task_dialog.dart`
**What:** Cuando `_isSubmitting = true`, los campos permanecen activos. Deshabilitar todos los `TextField` (`enabled: false`), añadir overlay semitransparente, texto "Guardando..." y prevenir múltiples envíos.
**Why:** `add_task_dialog.dart:167-217` no deshabilita campos durante submit. Usuarios pueden editar mientras se guarda o tocar submit múltiples veces. Causa inconsistencias y duplicados.
**Use /implement UX-11**

### UX-12: Empty States Contextuales con Acciones Directas
**Files:** `lib/widgets/task_list.dart`
**What:** Unificar los 3 estados vacíos (filtro activo, búsqueda activa, sin tareas) con iconos específicos por contexto, botones de acción prominentes ("Limpiar filtros", "Crear primera tarea"), y mensajes contextuales. Añadir botón "Crear tarea" en el estado vacío de "sin tareas".
**Why:** `task_list.dart:103-205` tiene 3 empty states con mensajes inconsistentes. El estado de 0 tareas dice "toca el botón +" sin mostrar dónde está ese botón. Usuarios nuevos se sienten perdidos.
**Use /implement UX-12**

---

### PROD-8: Snooze / Aplazamiento Inteligente de Tareas
**Files:** `lib/models/task_model.dart`, `lib/providers/task_provider.dart`, `lib/widgets/task_tile.dart`
**What:** Añadir campo `deferredUntil?: DateTime` al modelo Task. Opciones de snooze en gesto swipe-up o menú largo: "Mañana", "Próxima semana", "En 2 días", "Personalizado". Sección "Tareas aplazadas" en Today Screen.
**Why:** No existe forma de posponer una tarea sin eliminarla y recrearla. El modelo ya tiene `dueDate` y `deadline` pero no tiene snooze (`task_model.dart:24-25,45`). Los usuarios gestionan esto mentalmente en lugar de con la app.
**Use /implement PROD-8**

### PROD-9: Detección de Conflictos de Bloques de Tiempo
**Files:** `lib/models/task_model.dart`, `lib/widgets/calendar_view.dart`, `lib/providers/task_providers.dart`
**What:** Añadir campo `estimatedDurationMinutes?: int` al Task. Crear `timeBlockConflictProvider` que detecte solapamientos entre tareas con hora asignada. Badge de advertencia en TaskTile si hay conflicto. Vista de línea de tiempo en TodayScreen.
**Why:** `task_model.dart:33` tiene `dueTimeMinutes` pero sin duración. El calendario (`calendar_view.dart`) es estático y no detecta si 2 tareas en el mismo día se superponen horariamente. Usuarios se sobrecomprométen sin saberlo.
**Use /implement PROD-9**

### PROD-10: Etiquetas de Contexto y Completado por Contexto
**Files:** `lib/models/task_model.dart`, `lib/widgets/task_tile.dart`, `lib/widgets/task_list.dart`
**What:** Añadir `contextTags: List<String>` al Task con etiquetas predefinidas: "En casa", "En el trabajo", "Con pareja", etc. Mostrar pills de contexto en TaskTile. Filtrar tareas por contexto. Selección múltiple para completar todas las tareas de un contexto.
**Why:** `task_model.dart` solo tiene categoría semántica (Personal/Trabajo). Las notas ya tienen `tags` (`note_model.dart:78`) pero las tareas no. Los usuarios no pueden agrupar "qué hacer ahora que estoy en casa" vs "qué hacer en la oficina".
**Use /implement PROD-10**

### PROD-11: Dependencias entre Tareas
**Files:** `lib/models/task_model.dart`, `lib/providers/task_provider.dart`, `lib/widgets/task_tile.dart`
**What:** Añadir `dependsOn: List<String>` al Task. Mostrar badge "Bloqueada por: Tarea A" en TaskTile. Prevenir completado si dependencias no están hechas. Notificación cuando una tarea bloqueante se completa.
**Why:** No existe sistema de dependencias. Usuarios con flujos multi-paso (sprints, proyectos casa, rutas de aprendizaje) no pueden estructurar orden de ejecución. Los subtareas (PROD-6) manejan pasos internos; las dependencias manejan orden entre tareas distintas.
**Use /implement PROD-11**

---

### WB-9: Indicador de Tiempo de Completado (Gasto de Energía)
**Files:** `lib/models/task_history.dart`, `lib/providers/stats_provider.dart`, `lib/widgets/task_tile.dart`
**What:** Calcular `completionDurationMinutes` desde `createdAt` a `completedAt`. Widget en dashboard: "Estás completando tareas 25% más lento de lo normal — considera un descanso". Proveedor: `weeklyCompletionTimeProvider` con duración promedio por tipo de tarea.
**Why:** `task_history.dart:17` registra `completedAt` pero no calcula duración. Sin este dato el sistema no puede detectar cuándo el usuario está en modo burnout. Completar una tarea en 3 min vs 45 min son señales de energía muy distintas.
**Use /implement WB-9**

### WB-10: Auto-evaluación de Esfuerzo en Creación de Tarea
**Files:** `lib/models/task_model.dart`, `lib/widgets/dialogs/add_task_dialog.dart`, `lib/widgets/task_tile.dart`
**What:** Añadir `effort: 'light' | 'moderate' | 'heavy'` al Task (equivale a "5 min", "30 min", "2+ horas"). 3 botones de esfuerzo en AddTaskDialog. Dashboard muestra "Presupuesto de esfuerzo: 4h disponibles, 3.5h programadas".
**Why:** `add_task_dialog.dart:77-280` tiene prioridad pero no esfuerzo. Los usuarios confunden prioridad con duración. 5 tareas de alta prioridad pueden ser 15 minutos o 10 horas. Sin esta distinción, el síndrome del "día imposible" es inevitable.
**Use /implement WB-10**

### WB-11: Sugerencias de Bienestar según Estado de Ánimo
**Files:** `lib/providers/wellness_provider.dart`, `lib/widgets/dashboard/wellness_suggestions_card.dart`, `lib/core/constants/wellness_catalog.dart`
**What:** Check-in rápido en dashboard: "¿Cómo te sientes?" (5 estados: Energizado, Normal, Cansado, Agobiado, Ansioso). Filtrar sugerencias según estado: Cansado → sugerencias restaurativas; Agobiado → simplificación; Energizado → desafíos.
**Why:** `wellness_provider.dart:360-413` genera recomendaciones por hora del día pero ignora el estado emocional del usuario. Sugerir "1 hora de senderismo" a alguien agobiado es contraproducente y reduce engagement con el módulo de bienestar.
**Use /implement WB-11**

### WB-12: Recordatorios de Micro-Descanso en Días de Alta Carga
**Files:** `lib/widgets/task_tile.dart`, `lib/providers/streak_provider.dart`, `lib/widgets/shared/celebration_overlay.dart`
**What:** Rastrear velocidad de completado: si se completan 4+ tareas en <30 min o >10 en 2h, mostrar card opcional: "¿Tomas 5 minutos?" con animación de respiración o enlace a sugerencia de bienestar. Streak se preserva aunque el usuario tome la pausa.
**Why:** `task_tile.dart:33-36` muestra celebración en CADA completado sin detectar intensidad de sesión. No hay sistema que detecte cuándo el usuario lleva horas en modo sprint. Los microdescansos mejoran el foco y reducen errores.
**Use /implement WB-12**

### WB-13: Resumen Compasivo de Tareas Incompletas
**Files:** `lib/providers/day_cycle_provider.dart`, `lib/models/task_history.dart`, `lib/widgets/dashboard/evening_reflection_card.dart`
**What:** Al final del día, mostrar prompt: "3/5 tareas completas. ¿Por qué no llegó [tarea]?" con chips rápidos: "Inesperado", "Repriorizado", "Sin tiempo", "Necesitaba descanso". Mensaje compasivo: "Completaste el 60%. Eso es progreso real." Opción de deferir, eliminar o ajustar deadline.
**Why:** `day_cycle_provider.dart` tiene lógica de despedida pero sin revisión de incompletos. `task_history.dart` registra completados pero no razones de no completado. Los usuarios se culpan por tareas incompletas. Este sistema normaliza la incompletitud con datos, no con silencio.
**Use /implement WB-13**

---

### CODE-7: StreamSubscription Leak en ErrorStateNotifier
**Files:** `lib/providers/error_provider.dart:121-127`
**What:** La suscripción en el constructor de `ErrorStateNotifier` puede quedar activa si Riverpod recarga el provider sin llamar `dispose()`. Mover la suscripción al ciclo de vida del provider con `ref.onDispose()`.
**Why:** `error_provider.dart:121-127` suscribe en constructor sin garantía de cleanup en rutas de error. Pequeña fuga de memoria que escala con recargas de estado.
**Use /implement CODE-7**

### ~~CODE-8: Excepciones Genéricas en SyncOrchestrator~~ ✅ COMPLETADO (2026-02-20)
**File changed:** `lib/services/sync_orchestrator.dart`
**Implemented:** Replaced generic `Exception('Firestore not available')` at line 655 with `SyncException.uploadFailed()` and `Exception('No user ID available')` at line 659 with `AuthException.notAuthenticated()`. Both exceptions now properly integrate with the error handler's classification system, providing appropriate user messages, retry logic, and error categorization. The sync queue can now correctly identify auth failures vs infrastructure issues and apply the appropriate retry strategy.

### CODE-9: Cast Inseguro `.cast<T>()` sin Verificación de Tipo
**Files:** `lib/services/database_service.dart:434,502,542,704,814`
**What:** Añadir verificación de tipo antes de cada `.cast<Task/Note/Notebook>()`. Si un elemento no es del tipo esperado, lanzar `ValidationException` con mensaje descriptivo en lugar de crash silencioso.
**Why:** 5 lugares en `database_service.dart` usan `.cast<T>()` en listas de repositorios que devuelven `dynamic`. Un fallo de tipo en Hive causaría crash en runtime sin mensaje útil. Corrupción de datos pasaría silenciosamente.
**Use /implement CODE-9**

### CODE-10: O(N) Scan Completo en Stream Watchers de Hive
**Files:** `lib/services/database_service.dart:637-699`
**What:** `watchArchivedNotes()` y `watchNotesForTask()` hacen `box.values.toList()` (scan completo) en cada evento de `box.watch()`. Refactorizar para usar streams reactivos con `.map()` en lugar de re-escaneo completo.
**Why:** `database_service.dart:638,671,836` escanean todas las notas en CADA cambio del box. Con N notas y M cambios por sesión, el costo es O(N×M). Escala pobremente con usuarios que tienen cientos de notas.
**Use /implement CODE-10**

### CODE-11: StreamController sin Cleanup Garantizado en SyncOrchestrator
**Files:** `lib/services/sync_orchestrator.dart:244-245,344`, `lib/services/app_bootstrap.dart`
**What:** Si `init()` lanza excepción, `dispose()` nunca se llama y `_stateController` queda abierto. Envolver la inicialización en `try/finally` o registrar `ref.onDispose()` en el provider para garantizar cierre.
**Why:** `sync_orchestrator.dart:244` crea `StreamController.broadcast()` sin garantía de cierre en rutas de error de `init()`. Cualquier excepción en startup deja el controller abierto indefinidamente.
**Use /implement CODE-11**

---

### A11Y-6: Anuncios de Lector de Pantalla en Overlays de Celebración
**Files:** `lib/widgets/shared/celebration_overlay.dart:94`, `lib/widgets/shared/blessing_feedback.dart:150`, `lib/widgets/streak_celebration_widget.dart:129`
**What:** Envolver los 3 overlays en `Semantics(liveRegion: true, label: 'Tarea completada exitosamente')`. Llamar `SemanticsService.announce()` al mostrar el overlay.
**Why:** Los 3 overlays usan `IgnorePointer` que silencia el árbol de accesibilidad. Los usuarios con lector de pantalla no reciben ningún feedback cuando completan una tarea — el momento de celebración queda vacío para ellos.
**Use /implement A11Y-6**

### A11Y-7: Navegación por Teclado en Celdas de Calendario
**Files:** `lib/widgets/calendar_view.dart:189-258`
**What:** Reemplazar `GestureDetector` en celdas de día con `InkWell` dentro de `Material`, o añadir `FocusableActionDetector` con `ActivateIntent`. Añadir nodo de foco y soporte para Enter/Espacio en cada celda.
**Why:** `calendar_view.dart:193` usa `GestureDetector` puro para días del calendario. Los semánticos dicen "botón" pero no hay soporte de teclado real. Los usuarios que navegan con teclado no pueden seleccionar fechas.
**Use /implement A11Y-7**

### A11Y-8: Contraste de Color en Widget de Estadísticas
**Files:** `lib/widgets/task_stats.dart:145-211,274-284`
**What:** Reemplazar `Colors.yellow.shade700` con `Colors.amber.shade900` para texto de racha. Reemplazar `Colors.red.withValues(alpha: 0.6)` con `Colors.red.shade800` para puntos semanales. Verificar contraste usando `ColorUtils.getTextColorFor()`.
**Why:** `task_stats.dart:150` usa amarillo-700 y `task_stats.dart:280` usa rojo con 0.6 de opacidad. Ambos pueden fallar WCAG AA (4.5:1 para texto normal) en fondos claros. El 8% de hombres tiene deficiencia visual del color.
**Use /implement A11Y-8**

### A11Y-9: Alternativa de Teclado para Gestos de Deslizamiento
**Files:** `lib/widgets/task_tile.dart:430-546`
**What:** Añadir `CallbackShortcuts` alrededor del tile que mapee Ctrl+Derecha → completar, Ctrl+Izquierda → eliminar. Actualizar label semántico: "Deslizar derecha para completar, o Ctrl+Derecha con teclado".
**Why:** `task_tile.dart:430` usa `Dismissible` que es solo táctil. Los gestos swipe derecha (completar) e izquierda (eliminar) son las acciones principales de la app pero completamente inaccesibles para usuarios de teclado.
**Use /implement A11Y-9**

### A11Y-10: Labels Semánticos en Campos de Formulario de Edición
**Files:** `lib/widgets/dialogs/task_form_dialog.dart:47-49`
**What:** Usar `TextFormField` con `labelText:` en lugar de `TextField` con solo `hintText`. O añadir `Semantics(label: 'Nombre de la tarea')` sobre cada `TextField`. Asegurar que chips de prioridad/categoría tengan labels descriptivos.
**Why:** `task_form_dialog.dart:47-49` declara controladores para título, motivación y recompensa. Si usan `hintText` sin `labelText`, el lector de pantalla no puede identificar el propósito del campo cuando tiene contenido (hint desaparece al escribir).
**Use /implement A11Y-10**

---

## Recommended Next Steps

Orden de prioridad basado en impacto de usuario:

1. **AUTH-1 (Crear perfil en Firestore)** — CRÍTICO: bloquea sync para nuevos usuarios registrados.
2. **AUTH-2 (Visibilidad de eliminar cuenta)** — CRÍTICO: usuarios no pueden encontrar la opción.
3. **UX-5 (Swipe affordance)** — Quick win: gestos no son descubribles por nuevos usuarios.
4. **AUTH-3 (Cambio de contraseña)** — Importante: feature básica de gestión de cuenta faltante.
5. **PROD-2 (Notificaciones)** — Mayor impacto en retención: deadlines actualmente sin enforcement.
6. **AUTH-4 (Editar perfil)** — Mejora la experiencia de usuario registrado.
7. **WB-5 (Celebration settings)** — Previene fatiga en usuarios frecuentes.
8. **DATA-1 (Export datos)** — Cumple promesa de feature existente.
9. **AUTH-5 (Email verification)** — Seguridad y confianza.
10. **UX-7 (Skeleton loading)** — Mejora percepción de rendimiento.

---

## How to Implement

Use the `/implement` skill with the ID of any improvement:

```
/implement AUTH-1
/implement AUTH-2
/implement UX-5
```

Each implementation is atomic and won't break existing functionality.
